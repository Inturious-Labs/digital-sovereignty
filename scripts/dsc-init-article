#!/bin/bash

# DSC Init Article - Interactive frontmatter wizard
# Run this from within an article folder (e.g., content/posts/2025/12/09-my-article/)
# Creates index.md with frontmatter based on interactive prompts

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
GRAY='\033[0;90m'
NC='\033[0m'
BOLD='\033[1m'

# Standard keywords for all DSC articles (Part A)
STANDARD_KEYWORDS="ICP, Internet Computer, 互联网计算机, Internet Computer Protocol, canister, blockchain, crypto, decentralization, digital sovereignty, 区块链"

# Find repo root by looking for hugo.toml
find_repo_root() {
    local dir="$PWD"
    while [ "$dir" != "/" ]; do
        if [ -f "$dir/hugo.toml" ] && [ -d "$dir/content/posts" ]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

REPO_ROOT=$(find_repo_root)
if [ -z "$REPO_ROOT" ]; then
    echo -e "${RED}Error: Not inside the DSC repository${NC}"
    echo "Run this script from within content/posts/YYYY/MM/DD-slug/"
    exit 1
fi

POSTS_DIR="$REPO_ROOT/content/posts"

# Verify we're in an article folder
CURRENT_DIR="$PWD"
if [[ ! "$CURRENT_DIR" =~ content/posts/[0-9]{4}/[0-9]{2}/ ]]; then
    echo -e "${RED}Error: Not in an article folder${NC}"
    echo "Expected path pattern: content/posts/YYYY/MM/DD-slug/"
    echo "Current directory: $CURRENT_DIR"
    exit 1
fi

# Check if index.md already exists
if [ -f "index.md" ]; then
    echo -e "${YELLOW}Warning: index.md already exists in this folder${NC}"
    printf "${BLUE}Overwrite? [y/N]:${NC} "
    read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi
fi

# Extract slug from folder name (e.g., "09-my-article" -> "my-article")
FOLDER_NAME=$(basename "$CURRENT_DIR")
SLUG=$(echo "$FOLDER_NAME" | sed 's/^[0-9]*-//')

# Scan for existing categories from published posts
scan_categories() {
    find "$POSTS_DIR" -name "index.md" -exec awk '
        /^---/ { if (fc == 0) { fc++; inf = 1; next } else if (fc == 1) { inf = 0; fc++; next } }
        inf && /^draft: true/ { draft = 1 }
        inf && /^categories:/ { incat = 1; next }
        inf && incat && /^  - "/ {
            gsub(/^  - "/, ""); gsub(/"$/, "");
            if ($0 != "") cats[$0] = 1
        }
        inf && incat && /^[a-zA-Z]/ { incat = 0 }
        END { if (!draft) for (c in cats) print c }
    ' {} \; 2>/dev/null | sort -u | grep -v "^$" | tr '\n' ',' | sed 's/,$//'
}

# Scan for existing series from published posts
scan_series() {
    find "$POSTS_DIR" -name "index.md" -exec awk '
        /^---/ { if (fc == 0) { fc++; inf = 1; next } else if (fc == 1) { inf = 0; fc++; next } }
        inf && /^draft: true/ { draft = 1 }
        inf && /^series:/ { inser = 1; next }
        inf && inser && /^  - "/ {
            gsub(/^  - "/, ""); gsub(/"$/, "");
            if ($0 != "") sers[$0] = 1
        }
        inf && inser && /^[a-zA-Z]/ { inser = 0 }
        END { if (!draft) for (s in sers) print s }
    ' {} \; 2>/dev/null | sort -u | grep -v "^$" | tr '\n' ',' | sed 's/,$//'
}

# Interactive category selection
select_category() {
    local categories=$(scan_categories)

    echo -e "${GREEN}Category${NC} ${GRAY}(choose from existing or create new):${NC}" >&2

    if [ -n "$categories" ]; then
        IFS=',' read -ra cat_array <<< "$categories"

        local i=1
        for cat in "${cat_array[@]}"; do
            printf "  %d) %-20s" "$i" "$cat" >&2
            if [ $((i % 3)) -eq 0 ]; then echo "" >&2; fi
            ((i++))
        done
        [ $(((${#cat_array[@]}) % 3)) -ne 0 ] && echo "" >&2

        echo "  $((${#cat_array[@]}+1))) Enter new category" >&2
        printf "${GREEN}Choice [1-$((${#cat_array[@]}+1))]:${NC} " >&2
        read -r choice

        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#cat_array[@]}" ]; then
            echo "${cat_array[$((choice-1))]}"
        elif [ "$choice" = "$((${#cat_array[@]}+1))" ]; then
            printf "${GREEN}Enter new category:${NC} " >&2
            read -r new_cat
            echo "$new_cat"
        else
            echo "${cat_array[0]}"
        fi
    else
        printf "${GREEN}Enter category${NC} ${GRAY}(e.g., crypto, ai, blockchain):${NC} " >&2
        read -r cat
        echo "${cat:-general}"
    fi
}

# Interactive series selection
select_series() {
    local series_list=$(scan_series)

    echo -e "${GREEN}Series${NC} ${GRAY}(optional):${NC}" >&2

    if [ -n "$series_list" ]; then
        IFS=',' read -ra ser_array <<< "$series_list"

        echo "  0) None (skip)" >&2
        local i=1
        for ser in "${ser_array[@]}"; do
            echo "  $i) $ser" >&2
            ((i++))
        done
        echo "  $((${#ser_array[@]}+1))) Enter new series" >&2

        printf "${GREEN}Choice [0-$((${#ser_array[@]}+1))]:${NC} " >&2
        read -r choice

        if [ "$choice" = "0" ] || [ -z "$choice" ]; then
            echo ""
        elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#ser_array[@]}" ]; then
            echo "${ser_array[$((choice-1))]}"
        elif [ "$choice" = "$((${#ser_array[@]}+1))" ]; then
            printf "${GREEN}Enter new series:${NC} " >&2
            read -r new_ser
            echo "$new_ser"
        else
            echo ""
        fi
    else
        printf "${GREEN}Series name${NC} ${GRAY}(press Enter to skip):${NC} " >&2
        read -r ser
        echo "$ser"
    fi
}

echo -e "${BLUE}${BOLD}DSC Init Article${NC}"
echo -e "${GRAY}Creating index.md in: $CURRENT_DIR${NC}"
echo ""

# Title
printf "${GREEN}Title:${NC} "
read -r title
if [ -z "$title" ]; then
    echo -e "${RED}Title is required.${NC}"
    exit 1
fi

# Slug confirmation
printf "${GREEN}Slug${NC} ${GRAY}(from folder name):${NC} $SLUG ${GRAY}[Enter to accept, or type new]:${NC} "
read -r custom_slug
[ -n "$custom_slug" ] && SLUG="$custom_slug"

# Description
printf "${GREEN}Description${NC} ${GRAY}(for SEO):${NC} "
read -r description
[ -z "$description" ] && description="$title"

# Category
category=$(select_category)

# Series
series=$(select_series)

# Keywords - Part A (standard) is prefilled, Part B (article-specific) is optional
printf "${GREEN}Article-specific keywords${NC} ${GRAY}(comma-separated, optional - standard keywords auto-added):${NC} "
read -r extra_keywords

# Build keywords array - combine standard + article-specific
all_keywords="$STANDARD_KEYWORDS"
[ -n "$extra_keywords" ] && all_keywords="$all_keywords, $extra_keywords"

keyword_array=""
IFS=',' read -ra kw_list <<< "$all_keywords"
for kw in "${kw_list[@]}"; do
    kw=$(echo "$kw" | sed 's/^[ \t]*//;s/[ \t]*$//')
    [ -n "$keyword_array" ] && keyword_array="${keyword_array}, \"$kw\"" || keyword_array="\"$kw\""
done
keyword_field="[$keyword_array]"

# Create index.md
cat > "index.md" << EOF
---
title: "$title"
date: 2099-12-31T00:00:00+08:00
slug: $SLUG
draft: true
description: "$description"
categories:
  - "$category"
EOF

[ -n "$series" ] && cat >> "index.md" << EOF
series:
  - "$series"
EOF

cat >> "index.md" << EOF
images: [""]
keywords: $keyword_field
enable_rapport: true
---

![Featured Image](./featured-image.webp)

## Introduction

## Main Content

## Conclusion
EOF

echo ""
echo -e "${GREEN}index.md created successfully!${NC}"
echo ""
echo -e "${BLUE}Next steps:${NC}"
echo -e "  1. Add featured-image.webp to this folder"
echo -e "  2. Edit: ${YELLOW}cursor index.md${NC} (with quiet light theme)"
echo -e "     or:  ${YELLOW}open -a MacDown index.md${NC}"
echo -e "  3. Preview: ${YELLOW}hugo server -D${NC}"
echo -e "  4. Audit: ${YELLOW}dsc-audit${NC}"
echo -e "  5. Update date & set draft: false when ready"
